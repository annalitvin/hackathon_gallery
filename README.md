# Hackathon gallery
The application for the recognition of emotions on photos downloaded from the service flickr. Recognition occurs with the use of Face++ API.

Пример приложения доступен по ссылке:
[http://radiant-ridge-93121.herokuapp.com/photo_lists](http://radiant-ridge-93121.herokuapp.com/photo_lists/ "Ссылка на пример")

**Принцип работы приложения**
-------------------------

Приложение осуществляет отбор url изображений (фотографий) из хранилища Flickr по заданным условиям, поиск лиц на изображениях и анализ общей результирующей эмоции на изображениях, на которых были детектированы лица. Этот анализ осуществляется с использованием сервиса Face++. Фотографии отображаются на сранице отсортированными в соответствии с результирующей основной эмоцией.

Так как процесс загрузки и анализа фотографий с использованием API Flickr и Face++ достаточно долгий, для предотвращения длительной загрузки страницы предложен следующий подход. Отображение фотографий происходит на основании базы данных приложения. Запись информации от изображениях и эмоциях на них происходит асинхронно – в параллельном потоке. Этот процесс, как фоновый, возобновляется периодически, для проверки наличия новых фотографий на Flickr, не проанализированных и не внесённых в базу данных. Обновление срамницы происходит периодически с использованием технологии AJAX, то есть без перезагрузки. То есть даже если на бкенде идёт процесс загрузки и анализа изображений, на страницы они будут появляться по мере записи информации в базу данных.  

Рассмотрим структуру и работу приложение подробнее. Для реализации использован Python web фреймворк Django. Создана одна модель PhotoEmotion, которая представляет запись об изображении и его результирующей эмоции. Модель имеет два поля: photo_url – хранит адрес изображения и emotion – хранит результирующую эмоцию. Все константы: адреса и ключи API, user_id, photoset_id вынесены в отдельный конфигурационный файл. Так как отображение фотографий на странице осуществляется с применением AJAX, отображение главной страницы лишь рендерит шаблон gallery.html, который расширяется шаблоном основновным шаблоном home.html.  

Ядром функционарования бкенда является функция update_photos. Она работает в отдельном потоке. В ней имеется бесконечный цикл (while True), в котором с интервалом 50000 секунд (без учёт времени выполнения процесса) осуществляется запуск функций загрузки и анализа изображений.  

Для работы с API сервиса Flickr в приложении использована библиотека flickrapi. В указанной функции создаётся объект FlickrAPI. Осуществляется загрузка списка фотографий из конкретного альбома в виде множества. Также загружаем другое множество фотографий, содержащих descriotion #int20h. Это не тэг, как писалось в задании, а именно descriotion. Тэги у них другие. Первое множество дополняется элементами второго. Так как элементы множества уникальны, то это исключает повторение. Элементами множества являются url изображений. Запрашиваются url изображений, которые храняться в базе данных и для которых уже есть распознанные эмоции. Эти элементы исключаются из множества. Оставшееся множество передаётся в функцию, осуществляющую распознание эмоций и запись в базу данных. Функция detect_emotions_and_save получает на входе множество url изображений. В ней осуществляется для каждой отдельной фотографии выделение лиц с получением токенов и передача этих токенов для распознания эмоций. Происходит выделение суммарной результирующей (преобладающей эмоции) на дано изображении. Производится запись в базу данных.  

Для работы с API Face++ используется библиотека requests. Вначале посылается url фотографии на сервис выделения лиц. Если лица детектированы, мы получаем токены лиц. Если лиц несколько токены объединяются в строку через запятую (без пробела). С использованием такого списка токенов для каждого распознанного лица на фотографии Получаем список эмоций в процентном отношении. Значения элементов этих списков суммируются по каждой из эмоций. Затем определяется, для какой эмоций наблюдается максимальное значение. Она и считается результирующей для данного фото. Именно это значение сохраняется в базе данных.  

С использованием AJAX, каждые 5 секунд опрашивается обновление страницы на основании базы данных. Если есть там есть новые изображения, они будут динамически 
добавлены к имеющимся. На страницы фотографии отображаются отсортированными по эмоциям. Каждый раздел имеет заголовком эмоцию, определенную на основании анализа сервисом Face++. Фотографии, на которых не было зафиксировано лиц и распознано эмоций помечаются как NO EMOTIONS. Названия остальных эмоций (заголовки разделов) соответствуют названиям эмоций Face++. Также динамически формируется на основании имеющихся определённых эмоций главное меню. Оно содержит ссылки по хэштегам на разделы соответствующих эмоций. Меню формируется динамически на основании имеющихся эмоций. Также в интерфейсе пользователя присутствует кнопка «Вверх», возвращающая в начало страницы. Под каждой фотографией есть ссылка, позволяющая посмотреть её крупнее и в новой вкладке.  

